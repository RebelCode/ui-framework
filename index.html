<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>booking-str</title>
</head>
<body>
<!--<div id="app"></div>-->
<div id="new-app">
    <hello inline-template>
        <span>
          <h2>Instance 1: {{ selectValue }}</h2>
          {{ translate('Test') }}
        </span>
    </hello>
</div>

<div class="next-app">
    <hello inline-template>
        <span>
          <h2>Instance 2: {{ selectValue }}</h2>
          <input type="text" v-model="selectValue">
          <vueselect :options="['foo', 'bar', 'test']" v-model="selectValue"></vueselect>
          {{ translate('Test') }}
        </span>
    </hello>
</div>

<div class="next-app">
    <hello inline-template>
        <span>
          {{ translate('Test') }}
          <h2>Instance 3: {{ selectValue }}</h2>
          <vueselect :options="['foo', 'bar', 'test']" v-model="selectValue"></vueselect>
          <calendar :events="[{title: 'Sunny Out of Office',start: '2017-08-25',end: '2017-07-27'}]"
                    locale="en"></calendar>
          <button @click="testPlugin">boom</button>
        </span>
    </hello>
</div>

<script>
  if (!window.UiFramework) {
    window.UiFramework = {
      plugins: [],
      registerPlugin: function (name, plugin, priority = 10) {
        window.UiFramework.plugins[name] = {plugin, priority}
        if (window.UiFramework.emit) {
          window.UiFramework.emit('plugin-loaded', {name, plugin})
        }
        console.info('plugin registered', name, {plugin, priority}, window.UiFramework.plugins)
      }
    }
  }
</script>

<script>
    window.UiFramework.registerPlugin('test-plugin', {
      register: function (services) {
        services['testService'] = function (container) {
          return function () {
            console.info('call from registered test service')
          }
        }
        console.log('registered test service', services)
        return services
      },
      run: function (container) {
        console.log('running test service', container)
      }
    })
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // get default configuration inside the Bottle instance
    require.config({
      paths: {
        textFormatter: 'https://unpkg.com/sprintf-js@1.1.1/dist/sprintf.min',
        bottle: 'https://cdnjs.cloudflare.com/ajax/libs/bottlejs/1.6.1/bottle.min',
        vue: 'https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.4/vue',
        vuex: 'https://cdnjs.cloudflare.com/ajax/libs/vuex/3.0.1/vuex',
        calendar: 'https://cdn.jsdelivr.net/npm/vue2-full-calendar@1.0.15/dist/vue-fullcalendar.min',
        vueselect: 'https://unpkg.com/vue-select@2.0.1/dist/vue-select'
      }
    })

    var dependenciesList = ['uiFramework', 'textFormatter', 'bottle', 'vue', 'vuex', 'calendar', 'vueselect']

    function defineServices (dependencies) {
      return {
        translator: function () {
          return new dependencies.uiFramework.I18n.FormatTranslator(dependencies.textFormatter.sprintf)
        },
        vue: function (container) {
          var Vue = container._vue.extend()
          Vue.use(dependencies.uiFramework.Core.InjectedComponents)

          Vue.version = container._vue.version
          Vue.config = container._vue.config

          return Vue
        },
        translate: function (container) {
          return function (format, params, context) {
            return container.translator.translate(format, params)
          }
        },
        calendar: function () {
          return dependencies.calendar
        },
        vueselect: function () {
          return dependencies.vueselect.VueSelect
        },
        hello: function () {
          return {
            inject: ['translate', 'calendar', 'vueselect', 'store', 'testService'],
            computed: {
              selectValue: {
                get: function () {
                  return this.store.state.selectValue
                },
                set: function (newValue) {
                  this.store.commit('SET_VALUE', newValue)
                }
              }
            },
            methods: {
              testPlugin: function () {
                this.testService()
              }
            },
            components: {
              calendar: 'calendar',
              vueselect: 'vueselect'
            }
          }
        },
        components: function (container) {
          return {
            hello: container.hello,
            calendar: container.calendar,
            vueselect: container.vueselect
          }
        },
        document: function () {
          return document
        },
        _vue: function () {
          return dependencies.vue
        },
        vuex: function (container) {
          container.vue.use(dependencies.vuex)
          return dependencies.vuex
        },
        store: function (container) {
          var Vuex = container.vuex
          return new Vuex.Store({
            state: {
              selectValue: 'foo'
            },
            mutations: {
              SET_VALUE (state, value) {
                state.selectValue = value
              }
            }
          })
        }
      }
    }

    require(dependenciesList, function () {
      var dependencies = {}
      for (var i = 0; i < dependenciesList.length; i++) {
        dependencies[dependenciesList[i]] = arguments[i]
      }

      var services = defineServices(dependencies)

      var containerFactory = new dependencies.uiFramework.Container.ContainerFactory(dependencies.bottle)
      var app = new dependencies.uiFramework.Core.App(containerFactory, services)
      app.use(['test-plugin'])
      app.init([
        '#app',
        '#new-app',
        '.next-app'
      ])
    })
  })

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
</body>
</html>
